<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dokument</title>
</head>
<body>
<h2>Wygeneruj plik JSON</h2>

<label for="title">Tytuł filmu:</label>
<input type="text" id="title" placeholder="Wprowadź tytuł filmu">

<label for="videoUrl">Video URL:</label>
<input type="text" id="videoUrl" placeholder="Wprowadź Vido URL">

<label for="quality">Jakość:</label>
<select id="quality">
    <option value="1080p">1080p</option>
    <option value="720p">720p</option>
    <option value="540p">540p</option>
    <option value="360p">360p</option>
</select>

<button onclick="addField()">Dodaj</button>


<h3>Dodane linki:</h3>
<ul id="fields-list"></ul>

<button onclick="generateJSON()">Wygeneruj plik JSON</button>
<button onclick="clearFields()">Wyczyść</button>
<div id="result"></div>

<script>
    const fields = [];

    function addField() {
        const urlInput = document.getElementById('videoUrl');
        const qualitySelect = document.getElementById('quality');
        const titleInput = document.getElementById('title');
        const url = urlInput.value.trim();
        const quality = qualitySelect.value;
        const title = titleInput.value.trim();

        if (url && quality) {
            const fieldItem = `${url} (${quality})`;
            if (!fields.includes(fieldItem)) {
                fields.push(fieldItem);
                const fieldElement = document.createElement('li');
                fieldElement.textContent = fieldItem;
                document.getElementById('fields-list').appendChild(fieldElement);
                urlInput.value = '';
                qualitySelect.value = '1080p'; // Reset to default
            }
        }
    }

    function clearFields() {
        // Clear the fields array
        fields.length = 0;
        // Clear the fields list in the DOM
        document.getElementById('fields-list').innerHTML = '';
    }

    async function generateJSON() {
        const title = document.getElementById('title').value.trim();
        
        if (fields.length === 0) {
            console.log('Please add at least one URL and quality.');
            return;
        }

        const urls = fields.map(field => field.split(' ')[0]);
        const qualities = Array.from(new Set(fields.map(field => field.split(' ')[1].replace(/[()]/g, '')))); // Extract unique qualities

        // Calculate duration for each URL
        const durationPromises = urls.map(async (url) => {
            return new Promise((resolve, reject) => {
                const video = document.createElement('video');
                video.src = url;
                video.addEventListener('loadedmetadata', () => {
                    resolve(Math.ceil(video.duration)); // Round up to the nearest second
                });
                video.addEventListener('error', (e) => {
                    reject(`Error loading video: ${e}`);
                });
            });
        });

        try {
            const durations = await Promise.all(durationPromises);
            const totalDuration = Math.max(...durations); // Use the maximum duration

            // Construct the query parameters
            const apiUrl = `https://cytube.vercel.app/api/cytube?title=${encodeURIComponent(title)}&urls=${encodeURIComponent(urls.join(','))}&qualities=${encodeURIComponent(qualities.join(','))}&duration=${totalDuration}`;

            console.log('API URL:', apiUrl); // Debugging line

            // Make the API call
            const response = await fetch(apiUrl);
            const result = await response.json();
            console.log(result.fileName); // Handle the API response
	    const div = document.getElementById('result');
            div.innerHTML = `https://cdn.jsdelivr.net/gh/harambe-subtitles/cytube-json@main/${result.fileName}`;
        } catch (error) {
            console.log(error);
        }
    }
</script>

</body>
</html>
